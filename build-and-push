#!/bin/bash

set -eux

files=(*/Dockerfile)

build-and-push() (
  image=$(dirname $1)
  cd "$image"

  docker buildx build \
    --pull \
    --push \
    --cache-from=type=local,src=/tmp/.buildx-cache \
    --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
    --platform linux/amd64,linux/arm64 \
    -t "wint/$image:latest" \
    .

  # https://github.com/docker/build-push-action/issues/252
  # https://github.com/moby/buildkit/issues/1896
  tmp=$RANDOM
  mv /tmp/.buildx-cache /tmp/.buildx-cache.$tmp
  ( rm -rf /tmp/.buildx-cache.$tmp & ) # do not wait for deletion to complete
  mv /tmp/.buildx-cache-new /tmp/.buildx-cache
)

set -x
for f in "${files[@]}"; do
  build-and-push "$f"
done
