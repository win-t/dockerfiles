#!/bin/bash

set -eux

files=(*/Dockerfile)

build-and-push() (
  image=$(dirname $1)
  cd "$image"
  docker buildx build \
    --pull \
    --push \
    --cache-from=type=local,src=/tmp/.buildx-cache \
    --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
    --platform linux/amd64,linux/arm64 \
    -t "wint/$image:latest" \
    .
)

set -x
for f in "${files[@]}"; do
  build-and-push "$f"
done
